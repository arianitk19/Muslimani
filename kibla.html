<!DOCTYPE html>
<html lang="sq">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Kibla</title>
    <link rel="manifest" href="manifest.json">

<script src="theme-engine.js"></script>
    
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="Images/604776747_122280490772225847_4370550408157022665_n.jpg">

<script>
  // Ky kod i vogël ndalon hapjen e Safari-t kur kalon nga faqja në faqe
  if (("standalone" in window.navigator) && window.navigator.standalone) {
    var noddy, remotes = false;
    document.addEventListener('click', function(event) {
      noddy = event.target;
      while (noddy.nodeName !== "A" && noddy.nodeName !== "HTML") { noddy = noddy.parentNode; }
      if ('href' in noddy && noddy.href.indexOf('http') !== -1 && (noddy.href.indexOf(window.location.host) !== -1 || remotes)) {
        event.preventDefault();
        window.location = noddy.href;
      }
    }, false);
  }
</script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>

    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@200;300;400;500;600;700;800;900&display=swap');

    

    :root { 

        --primary: #10b981; 

        --bg: #020617; 

        --glass: rgba(255, 255, 255, 0.03); 

        --border: rgba(255, 255, 255, 0.08); 

    }



    body { 

        background: var(--bg); 

        color: white; 

        font-family: 'Plus Jakarta Sans', sans-serif; 

        -webkit-tap-highlight-color: transparent;

        -webkit-font-smoothing: antialiased;

        overflow: hidden;

        height: 100vh;

        display: flex;

        flex-direction: column;

    }



    /* Menu Trigger Zenith */

    .menu-trigger { 

        position: fixed; top: 2.5rem; right: 1.5rem; z-index: 2000; 

        padding: 12px; background: var(--glass); border-radius: 1.2rem; border: 1px solid var(--border);

        backdrop-filter: blur(10px);

    }

    .burger-line { width: 22px; height: 1.5px; background: var(--primary); margin: 5px 0; transition: 0.4s; border-radius: 10px; }

    .open .line-1 { transform: translateY(6.5px) rotate(45deg); }

    .open .line-2 { opacity: 0; }

    .open .line-3 { transform: translateY(-6.5px) rotate(-45deg); }



    #full-menu { 

        position: fixed; inset: 0; background: rgba(2, 6, 23, 0.98); backdrop-filter: blur(50px); 

        z-index: 1999; display: flex; flex-direction: column; justify-content: center; 

        padding: 3rem; visibility: hidden; opacity: 0; transition: 0.5s cubic-bezier(0.19, 1, 0.22, 1); 

    }

    #full-menu.active { visibility: visible; opacity: 1; }



    .menu-link {

        font-size: 2.5rem; font-weight: 700; margin: 1rem 0; display: flex; align-items: center; 

        gap: 1.5rem; color: rgba(255,255,255,0.4); transition: 0.4s; letter-spacing: -1px;

        text-decoration: none;

    }

    .menu-link i { font-size: 1.8rem; color: var(--primary); opacity: 0.5; }

    .menu-link:hover, .menu-link.active-page { color: white; transform: translateX(10px); }

    .menu-link.active-page i { opacity: 1; filter: drop-shadow(0 0 8px var(--primary)); }



    /* Compass Styling - RI-DIZAJNIM */

    .compass-container {

        position: relative;

        width: 320px;

        height: 320px;

        display: flex;

        align-items: center;

        justify-content: center;

    }



    .glass-card-circle { 

        background: radial-gradient(circle at center, rgba(255,255,255,0.05) 0%, transparent 70%);

        backdrop-filter: blur(20px); 

        border: 2px solid var(--border); 

        border-radius: 50%; 

        position: absolute;

        width: 100%;

        height: 100%;

        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);

    }



    /* Rrethi i shkallëve (Degrees) */

    .compass-degrees {

        position: absolute;

        width: 100%;

        height: 100%;

        border-radius: 50%;

        background-image: repeating-conic-gradient(

            from 0deg,

            var(--border) 0deg 1deg,

            transparent 1deg 30deg

        );

        mask-image: radial-gradient(transparent 65%, black 66%);

    }



    #compass-disc {

        width: 100%; height: 100%;

        position: relative;

        transition: transform 0.2s cubic-bezier(0.1, 0.3, 0.1, 1);

        will-change: transform;

    }



    .needle-qibla {

        position: absolute;

        top: 15%; left: 50%;

        transform: translateX(-50%);

        color: var(--primary);

        filter: drop-shadow(0 0 20px var(--primary));

        z-index: 5;

    }



    .aligned-glow {

        box-shadow: 0 0 60px rgba(16, 185, 129, 0.15), inset 0 0 20px rgba(16, 185, 129, 0.1);

        border-color: var(--primary) !important;

        transform: scale(1.02);

    }



    /* Modal styling */

    .modal-overlay { 

        display: flex; position: fixed; inset: 0; z-index: 3000; 

        background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(15px); 

        align-items: center; justify-content: center; padding: 20px; 

    }

    .modal-content { 

        background: linear-gradient(145deg, #051911 0%, #020617 100%); 

        border: 1px solid var(--border); border-radius: 3rem; width: 100%; 

        max-width: 380px; padding: 2.5rem; text-align: center;

    }



    /* Hub-i qendror me animacion */

    #center-hub {

        position: absolute;

        width: 80px; height: 80px;

        background: #020617;

        border: 2px solid var(--border);

        border-radius: 50%;

        display: flex; align-items: center; justify-content: center;

        box-shadow: 0 10px 30px rgba(0,0,0,0.5);

        z-index: 10;

    }

    

    .direction-indicator {

        position: absolute;

        width: 2px; height: 100%;

        background: linear-gradient(to bottom, var(--primary) 0%, transparent 50%);

        top: 0;

    }

</style>



<div class="menu-trigger" onclick="toggleMenu()">

    <div class="burger-line line-1"></div>

    <div class="burger-line line-2"></div>

    <div class="burger-line line-3"></div>

</div>



<nav id="full-menu">

    <div class="mb-12"><p class="text-emerald-500 font-black tracking-[0.4em] text-xs uppercase opacity-50">Navigimi</p></div>

    <a href="index.html" class="menu-link"><i class="fa-solid fa-house-chimney"></i> Vaktia</a>

    <a href="lutje.html" class="menu-link"><i class="fa-solid fa-hand-holding-heart"></i> Lutjet</a>

    <a href="kibla.html" class="menu-link active-page"><i class="fa-solid fa-compass"></i> Kibla</a>

    <a href="ligjeratat.html" class="menu-link"><i class="fa-solid fa-microphone-lines"></i> Ligjërata</a>

    <a href="info.html" class="menu-link"><i class="fa-solid fa-circle-info"></i> Info</a>

</nav>



<div id="permission-modal" class="modal-overlay">

    <div class="modal-content">

        <div class="w-16 h-16 bg-emerald-500/10 rounded-2xl flex items-center justify-center mx-auto mb-6">

            <i class="fa-solid fa-location-crosshairs text-emerald-500 text-2xl"></i>

        </div>

        <h2 class="text-3xl font-black italic tracking-tighter mb-4">Orientimi</h2>

        <p class="text-[10px] text-gray-500 font-bold uppercase tracking-widest mb-8 leading-relaxed">

            Lejoni qasjen në sensorët e lëvizjes dhe GPS për saktësi maksimale të drejtimit.

        </p>

        <button onclick="initSensor()" class="w-full py-4 bg-emerald-500 text-black rounded-2xl font-black text-[11px] uppercase tracking-[0.2em]">Aktivizo</button>

    </div>

</div>



<header class="pt-20 px-8">

    <div class="max-w-md mx-auto">

        <h1 class="text-5xl font-black italic tracking-tighter mb-2">Kibla<span class="text-emerald-500">.</span></h1>

        <p id="instruction" class="text-[10px] uppercase tracking-[0.3em] text-emerald-500 font-bold opacity-70">Duke llogaritur koordinatat...</p>

    </div>

</header>



<main class="flex-1 flex flex-col items-center justify-center p-6 relative">

    <div id="degree-val" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-[12rem] font-black italic tracking-tighter opacity-[0.03] pointer-events-none select-none">0°</div>



    <div class="compass-container">

        <div class="compass-degrees"></div>

        <div id="compass-disc" class="glass-card-circle">

            <div class="absolute top-6 left-1/2 -translate-x-1/2 text-[14px] font-black opacity-40">N</div>

            <div class="absolute bottom-6 left-1/2 -translate-x-1/2 text-[14px] font-black opacity-40">S</div>

            <div class="absolute right-6 top-1/2 -translate-y-1/2 text-[14px] font-black opacity-40">E</div>

            <div class="absolute left-6 top-1/2 -translate-y-1/2 text-[14px] font-black opacity-40">W</div>

            

            <div class="needle-qibla">

                <i class="fa-solid fa-location-arrow text-6xl rotate-45"></i>

            </div>

        </div>



        <div id="center-hub">

            <i class="fa-solid fa-kaaba text-3xl text-white"></i>

        </div>

    </div>



    <div id="qibla-info" class="mt-12 text-center">

        <p id="city-name" class="text-[10px] font-black uppercase tracking-widest text-white/40 mb-2">Vendndodhja jote</p>

        <div class="flex items-baseline gap-2 justify-center">

            <span id="dist-val" class="text-2xl font-black italic">--</span>

            <span class="text-[10px] font-bold opacity-30 uppercase">KM deri në Mekë</span>

        </div>

    </div>

</main>



<script>

    const disc = document.getElementById('compass-disc');

    const degVal = document.getElementById('degree-val');

    const instr = document.getElementById('instruction');

    const modal = document.getElementById('permission-modal');

    

    let userLocation = { lat: 0, lng: 0 };

    let qiblaAngle = 143; // Default Ratkoc



    // --- LLOGARITJA E SAKTË E KIBLËS (Formula Haversine & Bearing) ---

    function calculateQibla(lat, lng) {

        const kaaba = { lat: 21.4225, lng: 39.8262 };

        const phiK = kaaba.lat * Math.PI / 180.0;

        const lambdaK = kaaba.lng * Math.PI / 180.0;

        const phi = lat * Math.PI / 180.0;

        const lambda = lng * Math.PI / 180.0;

        

        const angle = Math.atan2(Math.sin(lambdaK - lambda), Math.cos(phi) * Math.tan(phiK) - Math.sin(phi) * Math.cos(lambdaK - lambda));

        return (angle * 180.0 / Math.PI + 360) % 360;

    }



    async function initSensor() {

        // Merr lokacionin fiks para se të nisim sensorët

        navigator.geolocation.getCurrentPosition(pos => {

            userLocation.lat = pos.coords.latitude;

            userLocation.lng = pos.coords.longitude;

            qiblaAngle = calculateQibla(userLocation.lat, userLocation.lng);

            document.getElementById('city-name').innerText = "Koordinatat u përditësuan";

            

            // Llogarit distancën

            const R = 6371; 

            const dLat = (21.4225 - userLocation.lat) * Math.PI / 180;

            const dLon = (39.8262 - userLocation.lng) * Math.PI / 180;

            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(userLocation.lat * Math.PI/180) * Math.cos(21.4225 * Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);

            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            document.getElementById('dist-val').innerText = Math.round(R * c);

        });



        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {

            const permission = await DeviceOrientationEvent.requestPermission();

            if (permission === 'granted') startCompass();

        } else {

            startCompass();

        }

        modal.style.display = 'none';

    }



    function startCompass() {

        window.addEventListener('deviceorientationabsolute', handleOrientation, true);

        window.addEventListener('deviceorientation', handleOrientation, true);

    }



    function handleOrientation(e) {

        let heading = e.webkitCompassHeading || (360 - e.alpha);

        

        if (heading) {

            // Rrotullimi i diskut në raport me veriun magnetik dhe këndin e Kiblës

            const rotation = qiblaAngle - heading;

            disc.style.transform = `rotate(${rotation}deg)`;

            

            let roundedHeading = Math.round(heading);

            degVal.innerText = roundedHeading + "°";



            // Saktësia (Glow kur je fiks)

            const diff = Math.abs((roundedHeading % 360) - Math.round(qiblaAngle));

            if (diff < 2 || diff > 358) {

                disc.classList.add('aligned-glow');

                instr.innerText = "JE NË DREJTIMIN E SAKTË";

                instr.style.color = "var(--primary)";

                if(navigator.vibrate) navigator.vibrate(20);

            } else {

                disc.classList.remove('aligned-glow');

                instr.innerText = "RROTULLOHU NGADALË";

                instr.style.color = "white";

            }

        }

    }



    function toggleMenu() {

        document.querySelector('.menu-trigger').classList.toggle('open');

        document.getElementById('full-menu').classList.toggle('active');

    }



    // Përshtatja e ngjyrave globale

    function applyGlobalSettings() {

        const savedTheme = localStorage.getItem('pd_primary_color') || '#10b981';

        document.documentElement.style.setProperty('--primary', savedTheme);

    }



    window.onload = applyGlobalSettings;

</script>
    
</html>









